{% extends 'base.html' %}

{% block content %}
<div class="header-section">
    <h2>Attendance Correction</h2>
    <a href="{{ url_for('admin_dashboard') }}" class="btn-secondary">Back to Dashboard</a>
</div>

<!-- Filter Section -->
<div class="card-section mb-4">
    <form method="POST" action="{{ url_for('admin_attendance_correction') }}" class="filter-form">
        <div class="form-group">
            <label>Department</label>
            <select name="department_id" onchange="this.form.submit()" required>
                <option value="">-- Select Department --</option>
                {% for dept in departments %}
                <option value="{{ dept.id }}" {% if selected_dept_id and selected_dept_id|string==dept.id|string
                    %}selected{% endif %}>
                    {{ dept.name }} ({{ dept.code }})
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label>Subject</label>
            <select name="subject_id" required {% if not subjects %}disabled{% endif %}>
                <option value="">-- Select Subject --</option>
                {% for sub in subjects %}
                <option value="{{ sub.id }}" {% if selected_subject and selected_subject.id==sub.id %}selected{% endif
                    %}>
                    {{ sub.name }} ({{ sub.code }})
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label>Date</label>
            <input type="date" name="date" required value="{{ selected_date }}">
        </div>
        <button type="submit" class="btn-primary" style="align-self: flex-end; margin-bottom: 1.5rem;">Load
            Records</button>
    </form>
</div>

{% if selected_subject %}
<hr class="divider">

<!-- Correction table -->
<div class="card-section">
    <h3>Records for {{ selected_subject.name }} on {{ selected_date }}</h3>

    <form method="POST" action="{{ url_for('admin_update_attendance') }}">
        <input type="hidden" name="subject_id" value="{{ selected_subject.id }}">
        <input type="hidden" name="date" value="{{ selected_date }}">

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Reg No</th>
                        <th>Name</th>
                        <th>Current Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rec in attendance_records %}
                    <tr>
                        <td>{{ rec.register_no }}</td>
                        <td>{{ rec.student_name }}</td>
                        <td>
                            <div class="radio-group">
                                <label class="radio-label radio-present">
                                    <input type="radio" name="status_{{ rec.student_id }}" value="Present" {% if
                                        rec.status=='Present' %}checked{% endif %}> P
                                </label>
                                <label class="radio-label radio-absent">
                                    <input type="radio" name="status_{{ rec.student_id }}" value="Absent" {% if
                                        rec.status=='Absent' %}checked{% endif %}> A
                                </label>
                                <label class="radio-label radio-od">
                                    <input type="radio" name="status_{{ rec.student_id }}" value="On Duty" {% if
                                        rec.status=='On Duty' %}checked{% endif %}> OD
                                </label>
                                <!-- If no status (NULL), default to unchecked or handle? -->
                                {% if not rec.status %}
                                <span class="not-marked-label">(Not Marked)</span>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="3">No students found matching criteria.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="actions mt-3">
            <button type="submit" class="btn-primary">Update Attendance</button>
        </div>
    </form>
</div>
{% endif %}

<style>
    .filter-form {
        display: flex;
        gap: 1.5rem;
        flex-wrap: wrap;
    }

    .filter-form .form-group {
        min-width: 250px;
        flex: 1;
        margin-bottom: 0;
    }

    .mb-4 {
        margin-bottom: 2rem;
    }

    .divider {
        border: 0;
        border-top: 1px solid var(--border-color);
        margin: 2rem 0;
    }

    .radio-group {
        display: flex;
        gap: 1rem;
    }

    .radio-label {
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.3rem;
        font-weight: 500;
    }

    .radio-present {
        color: var(--success);
    }

    .radio-absent {
        color: var(--danger);
    }

    .radio-od {
        color: #f59e0b;
    }

    .not-marked-label {
        color: var(--text-muted);
        font-size: 0.8rem;
        font-style: italic;
        margin-left: 0.5rem;
    }

    .mt-3 {
        margin-top: 1.5rem;
    }

    @media (max-width: 768px) {
        .filter-form {
            flex-direction: column;
            gap: 1rem;
        }

        .filter-form .form-group {
            width: 100%;
        }

        .btn-primary {
            width: 100%;
        }
    }
</style>
{% endblock %}