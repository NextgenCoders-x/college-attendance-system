{% extends 'base.html' %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2>Department Attendance Overview</h2>
        </div>
        <hr>
    </div>
</div>

<!-- Filter Section -->
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0">Filter Students</h5>
    </div>
    <div class="card-body">
        <form method="GET" action="{{ url_for('admin_attendance_overview') }}" class="form-inline">
            <div class="form-group mr-3 mb-2">
                <label for="department_id" class="mr-2">Department:</label>
                <select class="form-control" id="department_id" name="department_id" required>
                    <option value="">-- Select Department --</option>
                    {% for dept in departments %}
                    <option value="{{ dept.id }}" {% if selected_dept|int==dept.id %}selected{% endif %}>
                        {{ dept.name }} ({{ dept.code }})
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group mr-3 mb-2">
                <label for="year" class="mr-2">Year:</label>
                <select class="form-control" id="year" name="year">
                    <option value="">-- All Years --</option>
                    <option value="I" {% if selected_year=='I' %}selected{% endif %}>I</option>
                    <option value="II" {% if selected_year=='II' %}selected{% endif %}>II</option>
                    <option value="III" {% if selected_year=='III' %}selected{% endif %}>III</option>
                    <option value="IV" {% if selected_year=='IV' %}selected{% endif %}>IV</option>
                </select>
            </div>

            <div class="filter-actions">
                <a href="{{ url_for('admin_attendance_overview') }}" class="btn btn-secondary">Reset</a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-filter"></i> Apply Filter
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    .filter-actions {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        margin-top: 12px;
        flex-wrap: wrap;
        width: 100%;
    }

    /* CUSTOM MOBILE SCROLL BEHAVIOR */
    .admin-table-scroll-wrapper {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        /* Ensure it doesn't force parent width */
        max-width: 100vw;
    }

    /* Force table to keep its width and not squeeze */
    .admin-table-scroll-wrapper table {
        width: 100%;
        min-width: 800px !important;
        /* Forces scroll on mobile screens < 800px */
        border-collapse: collapse;
    }

    /* Optional: Ensure cells don't wrap awkwardly */
    .admin-table-scroll-wrapper th,
    .admin-table-scroll-wrapper td {
        white-space: nowrap;
    }
</style>

<!-- Results Table -->
{% if students %}
<div class="card">
    <div class="card-body p-0">
        <div class="admin-table-scroll-wrapper">
            <table class="table table-striped table-hover mb-0">
                <thead class="thead-dark">
                    <tr>
                        <th>Register No</th>
                        <th>Student Name</th>
                        <th>Department</th>
                        <th>Year</th>
                        <th class="text-center">Overall Attendance</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                    <tr>
                        <td>{{ student.register_no }}</td>
                        <td>{{ student.name }}</td>
                        <td>{{ student.dept_name }}</td>
                        <td>{{ student.current_year }}</td>
                        <td class="text-center">
                            {% if student.percentage >= 75 %}
                            <span class="badge badge-success" style="font-size: 1rem;">{{ student.percentage }}%</span>
                            {% elif student.percentage >= 65 %}
                            <span class="badge badge-warning" style="font-size: 1rem;">{{ student.percentage }}%</span>
                            {% else %}
                            <span class="badge badge-danger" style="font-size: 1rem;">{{ student.percentage }}%</span>
                            {% endif %}

                            <!-- Progress Bar -->
                            <div
                                style="width: 100%; height: 6px; background-color: #e9ecef; border-radius: 99px; margin-top: 8px; overflow: hidden; max-width: 140px; margin-left: auto; margin-right: auto;">
                                <div
                                    style="width: {{ student.percentage }}%; height: 100%; background-color: #4F46E5; border-radius: 99px;">
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% elif selected_dept %}
<div class="alert alert-info">No students found matching the criteria.</div>
{% else %}
<div class="alert alert-secondary">Please select a department to view student attendance.</div>
{% endif %}

<div class="mt-4">
    <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
</div>
{% endblock %}